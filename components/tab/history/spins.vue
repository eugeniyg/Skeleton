<template>
  <div class="tab-history__tb" v-if="spins.length">
    <div class="tb-spins-history">
      <div class="row">
        <div
          v-for="(column, itemIndex) in headTitles"
          :key="itemIndex"
          class="th"
        >
          {{ column }}
        </div>
      </div>

      <template v-if="spins.length">
        <div v-for="(spin, itemIndex) in spins" :key="itemIndex" class="row">
          <div class="td">{{ spin.game}}</div>
          <div class="td">{{ formatSum(spin.currency, spin.amount) }}</div>
          <div class="td">{{ formatSum(spin.currency, spin.payout) }}</div>
          <div class="td">{{ dayjs(spin.createdAt).format('DD.MM.YYYY, HH:mm') }}</div>
        </div>
      </template>
    </div>

    <atomic-pagination
      v-if="pageMeta?.totalPages > 1"
      v-bind="pageMeta"
      @selectPage="changePage"
    />
  </div>

  <atomic-empty
    v-else-if="!loading"
    variant="bets-history"
    :title="props.content?.empty?.title"
    :subTitle="props.content?.empty?.description"
  />
</template>

<script setup lang="ts">
  import { IPaginationMeta, ISpinHistory } from '@skeleton/core/types';
  import { ISpinsHistory } from '~/types';

  const props = defineProps<{
    content: ISpinsHistory,
  }>();

  const dayjs = useDayjs();
  const headTitles = Object.values(props.content?.tableColumns || {});
  const loading = ref<boolean>(true);
  const spins = ref<ISpinHistory[]>([]);
  const pageMeta = ref<IPaginationMeta>();

  const { getSpinsHistory } = useCoreGamesApi();
  const spinsRequest = async (page: number = 1):Promise<void> => {
    loading.value = true;
    const response = await getSpinsHistory(page, 10);
    spins.value = response.data;
    pageMeta.value = response.meta;
    loading.value = false;
  };

  const changePage = (page: number):void => {
    if (loading.value) return;
    window.scroll(0, 0);
    spinsRequest(page);
  };

  const { formatBalance } = useProjectMethods();
  const formatSum = (currency: string, amount: number):string => {
    const balanceFormat = formatBalance(currency, amount);
    return `${balanceFormat.amount} ${balanceFormat.currency}`;
  };

  onMounted(() => { spinsRequest(); });
</script>

<style src="~/assets/styles/components/tab/history/spins.scss" lang="scss" />

